<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PPE Donning and Doffing Order - DAC 300 Prototype</title>
<style>
 :root{
 --blue-primary:#01549e;
 --blue-secondary:#507ABB;
 --orange-1:#be5510;
 --orange-2:#cb6015;
 --teal:#0093b2;
 --highlight:#fbeeb8;
 --bg:#f7f9fc;
 --text:#1b2838;
 --muted:#6b7a90;
 --card:#ffffff;
 --ring:#e1e8f5;
 }
 *{box-sizing:border-box}
 html,body{height:100%}
 body{
 margin:0;
 font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
 background:var(--bg);
 color:var(--text);
 line-height:1.45;
 }
 .wrap{
 max-width:980px;
 margin:0 auto;
 padding:20px 16px 40px;
 }
 h2{
 margin:0 0 6px 0;
 font-size:1.6rem;
 color:var(--blue-primary);
 letter-spacing:.2px;
 }
 .sub{
 color:var(--muted);
 margin:0 0 12px 0;
 font-size:.98rem;
 }
 hr.divider{
 border-width:2px;
 border-color:var(--blue-secondary);
 padding-left:72px;
 margin:14px 0 18px;
 }
 .note{
 background:var(--highlight);
 padding:10px 12px;
 border-radius:10px;
 border:1px solid #eadca2;
 margin:0 0 12px 0;
 font-size:.95rem;
 }
 .card{
 background:var(--card);
 border:1px solid var(--ring);
 border-radius:16px;
 box-shadow:0 1px 0 rgba(0,0,0,.03);
 }
 .panel{
 display:grid;
 grid-template-columns: 1fr 320px;
 gap:16px;
 }
 @media (max-width:900px){
 .panel{grid-template-columns:1fr}
 }
 .modebar{
 display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;
 }
 .seg{
 position:relative;
 background:#eef3fb;
 border:1px solid var(--ring);
 border-radius:12px;
 padding:4px;
 display:inline-flex;
 gap:4px;
 }
 .seg button{
 appearance:none;
 border:0;
 background:transparent;
 padding:8px 12px;
 border-radius:8px;
 font-weight:600;
 color:var(--blue-primary);
 cursor:pointer;
 }
 .seg button[aria-pressed="true"]{
 background:var(--card);
 box-shadow:0 1px 0 rgba(0,0,0,.04), inset 0 0 0 1px var(--ring);
 }
 .board{
 padding:12px;
 }
 .list{
 display:flex;
 flex-direction:column;
 gap:10px;
 list-style:none;
 margin:0;
 padding:0;
 }
 .item{
 display:grid;
 grid-template-columns:1fr auto;
 align-items:center;
 gap:8px;
 background:var(--card);
 border:1px solid var(--ring);
 border-radius:12px;
 padding:12px;
 box-shadow:0 1px 0 rgba(0,0,0,.03);
 }
 .item[draggable="true"]{
 cursor:grab;
 }
 .item.dragging{opacity:.6}
 .handle{
 display:flex;gap:6px;
 }
 .handle button{
 appearance:none;
 border:1px solid var(--ring);
 background:#f4f7fc;
 color:#2b3b55;
 padding:6px 8px;
 border-radius:8px;
 cursor:pointer;
 }
 .handle button:focus{outline:2px solid var(--blue-secondary);outline-offset:2px}
 .ghost{
 height:6px;
 border:2px dashed var(--teal);
 border-radius:3px;
 margin:3px 0;
 background: rgba(0, 147, 178, 0.2);
 }
 .actions{
 display:flex;gap:8px;flex-wrap:wrap;margin-top:12px;
 }
 .btn{
 appearance:none;
 border:1px solid var(--ring);
 background:var(--blue-primary);
 color:#fff;
 border-radius:10px;
 padding:10px 12px;
 font-weight:600;
 cursor:pointer;
 }
 .btn.secondary{
 background:#f4f7fc;
 color:#123;
 }
 .btn.ghost{
 background:#fff;
 }
 .btn:disabled{opacity:.6;cursor:not-allowed}
 .sidebar{
 padding:12px;
 display:flex;
 flex-direction:column;
 gap:12px;
 }
 .infocard{
 padding:12px;
 background:#fff;
 border:1px solid var(--ring);
 border-radius:12px;
 }
 .infocard h4{
 margin:0 0 6px 0;
 font-size:1.02rem;
 color:#0f2340;
 }
 .score{
 display:flex;align-items:center;gap:10px;
 font-weight:700;color:var(--blue-primary);
 font-size:1.05rem;
 }
 .badge{
 display:inline-flex;align-items:center;gap:6px;
 border:1px solid var(--ring);
 background:#f4f7fc;
 padding:6px 8px;border-radius:999px;
 color:#22344c;
 font-weight:600;
 }
 .good{color:#146c2e}
 .warn{color:#a86800}
 .bad{color:#9b1c1c}
 .rationale{
 background:#fff7e6;border:1px solid #f0d39a;border-radius:10px;padding:10px;font-size:.96rem;
 }
 .keyhelp{
 font-size:.92rem;color:#2d3f5c;
 }
 .sr-only{
 position:absolute !important;
 height:1px;width:1px;overflow:hidden;
 clip:rect(1px, 1px, 1px, 1px);
 white-space:nowrap;border:0;padding:0;margin:-1px;
 }
 .footer-note{
 margin-top:10px;color:var(--muted);font-size:.9rem;
 }
</style>
</head>
<body>
 <div class="wrap">
 <h2>PPE Donning and Doffing Order</h2>
 <hr class="divider">
 <div class="note" role="note">
 <strong>Instructions:</strong> First choose whether you're practicing Donning (putting on) or Doffing (taking off) PPE. Drag the steps into the correct order, then click <em>Check order</em> to see how you did. You can also use the Move up and Move down buttons for keyboard control.
 </div>

 <div class="panel">
 <section class="card board" aria-labelledby="boardTitle">
 <div class="modebar" role="group" aria-label="Mode">
 <div class="seg" role="tablist" aria-label="Select mode">
 <button id="btnDon" role="tab" aria-selected="true" aria-pressed="true">Donning</button>
 <button id="btnDof" role="tab" aria-selected="false" aria-pressed="false">Doffing</button>
 </div>
 </div>

 <h3 id="boardTitle" style="color:var(--blue-primary); margin:4px 0 8px 0; font-size:1.1rem;">Arrange the steps</h3>
 <ul id="list" class="list" aria-describedby="kbdHelp" aria-live="polite"></ul>
 <div class="actions">
 <button class="btn" id="checkBtn">Check order</button>
 <button class="btn secondary" id="resetBtn">Reset</button>
 <button class="btn" id="copyBtn" style="display:none;">Copy summary</button>
 </div>
 <p id="kbdHelp" class="keyhelp">Keyboard: Tab to a step, then use the Move up or Move down buttons to reorder. Drag and drop is also supported.</p>
 </section>

 <aside class="sidebar">
 <div class="infocard">
 <h4>Score</h4>
 <div class="score"><span id="scoreVal">–</span></div>
 </div>
 <div class="infocard">
 <h4>Feedback</h4>
 <div id="feedback" class="rationale">Choose a mode and arrange the steps. When you check your order, the first incorrect step will include a short explanation and the fix.</div>
 </div>
 <div class="infocard">
 <h4>Reference order</h4>
 <div id="reference" style="font-size:.95rem; color:#22344c;">Donning: Gown → Mask or respirator → Goggles or face shield → Gloves<br>Doffing: Gloves → Goggles or face shield → Gown → Mask or respirator</div>
 </div>
 </aside>
 </div>

 <div id="live" class="sr-only" aria-live="polite"></div>
 </div>

<script>
(function(){
 const DATA = {
 donning: [
 {id:'gown', label:'Gown', rationale:'Put on the gown first so clothing is covered before applying other equipment.'},
 {id:'mask', label:'Mask or respirator', rationale:'Secure the mask or respirator before eye protection so the nose and mouth are covered properly.'},
 {id:'goggles', label:'Goggles or face shield', rationale:'Add eye protection after mask to prevent contamination while adjusting the respirator or mask.'},
 {id:'gloves', label:'Gloves', rationale:'Gloves go on last so they remain clean during donning.'}
 ],
 doffing: [
 {id:'gloves', label:'Gloves', rationale:'Remove gloves first because they are typically the most contaminated.'},
 {id:'goggles', label:'Goggles or face shield', rationale:'Handle eye protection by the strap or arms only to avoid contact with the front surface.'},
 {id:'gown', label:'Gown', rationale:'Untie and peel the gown away from the body, turning it inside out to contain contamination.'},
 {id:'mask', label:'Mask or respirator', rationale:'Remove the mask or respirator last, touching straps only and avoiding the front. In some settings, remove after leaving the patient area.'}
 ]
 };

 const state = {
 mode:'donning',
 order:[],
 score:null,
 lastResult:null
 };

 const listEl = document.getElementById('list');
 const feedbackEl = document.getElementById('feedback');
 const scoreVal = document.getElementById('scoreVal');
 const copyBtn = document.getElementById('copyBtn');
 const resetBtn = document.getElementById('resetBtn');
 const checkBtn = document.getElementById('checkBtn');
 const btnDon = document.getElementById('btnDon');
 const btnDof = document.getElementById('btnDof');
 const live = document.getElementById('live');

 function setMode(mode){
 state.mode = mode;
 btnDon.setAttribute('aria-pressed', mode==='donning');
 btnDof.setAttribute('aria-pressed', mode==='doffing');
 btnDon.setAttribute('aria-selected', mode==='donning');
 btnDof.setAttribute('aria-selected', mode==='doffing');
 renderList();
 feedbackEl.innerHTML = 'Arrange the steps, then select <em>Check order</em>. The first incorrect step will include a short explanation and the fix.';
 scoreVal.textContent = '–';
 state.score = null;
 copyBtn.style.display = 'none';
 }

 function renderList(){
 listEl.innerHTML = '';
 const items = DATA[state.mode].map(x=>({...x}));
 state.order = items.map(x=>x.id);
 for (const item of items){
 const li = document.createElement('li');
 li.className = 'item';
 li.setAttribute('draggable','true');
 li.dataset.id = item.id;
 li.innerHTML = `
 <div>
 <div style="font-weight:700">${escapeHTML(item.label)}</div>
 <div style="font-size:.9rem;color:#38506e">Step</div>
 </div>
 <div class="handle" aria-label="Reorder controls">
 <button type="button" class="up" aria-label="Move up">Move up</button>
 <button type="button" class="down" aria-label="Move down">Move down</button>
 </div>
 `;
 listEl.appendChild(li);
 }
 attachDnD();
 }

 function indexById(id){
 return state.order.indexOf(id);
 }

 function move(id, dir){
 const i = indexById(id);
 const j = i + dir;
 if (i<0 || j<0 || j>=state.order.length) return;
 const arr = state.order;
 [arr[i], arr[j]] = [arr[j], arr[i]];
 // Update DOM to reflect new order
 const nodes = [...listEl.children];
 const nodeI = nodes[i];
 const nodeJ = nodes[j];
 if (dir === 1){
 listEl.insertBefore(nodeJ, nodeI);
 } else {
 listEl.insertBefore(nodeI, nodeJ);
 }
 live.textContent = `${getLabel(arr[i])} moved ${dir===1?'down':'up'}.`;
 }

 function getLabel(id){
 const all = DATA.donning.concat(DATA.doffing);
 const found = all.find(x=>x.id===id);
 return found ? found.label : id;
 }

 function getRationale(id, mode){
 const found = DATA[mode].find(x=>x.id===id);
 return found ? found.rationale : '';
 }

 function checkOrder(){
 const target = DATA[state.mode].map(x=>x.id);
 const current = state.order.slice();
 let firstWrongIdx = -1;
 for (let i=0;i<target.length;i++){
 if (current[i] !== target[i]){ firstWrongIdx = i; break; }
 }
 let score = 0;
 if (firstWrongIdx === -1){
 score = 100;
 feedbackEl.innerHTML = `<span class="good"><strong>Correct.</strong></span> Your sequence matches the recommended order.`;
 copyBtn.style.display = 'inline-block';
 setCompletion(score);
 } else {
 // Determine if this is a single swap away
 const mismatches = [];
 for (let i=0;i<target.length;i++){
 if (current[i] !== target[i]) mismatches.push(i);
 }
 const singleSwap = (mismatches.length === 2) &&
 (current[mismatches[0]] === target[mismatches[1]]) &&
 (current[mismatches[1]] === target[mismatches[0]]);
 score = singleSwap ? 80 : 50;
 const wrongId = current[firstWrongIdx];
 const correctId = target[firstWrongIdx];
 const rationale = getRationale(correctId, state.mode);
 feedbackEl.innerHTML = `<div class="rationale"><strong>Check step ${firstWrongIdx+1}.</strong> You placed <em>${escapeHTML(getLabel(wrongId))}</em>, but the recommended step is <em>${escapeHTML(getLabel(correctId))}</em>. ${escapeHTML(rationale)}</div>`;
 copyBtn.style.display = 'none';
 }
 state.score = score;
 scoreVal.textContent = `${score}`;
 postHeight();
 }

 function showCorrect(){
 const target = DATA[state.mode].map(x=>x.id);
 state.order = target.slice();
 // Rebuild DOM to target order
 const mapping = {};
 [...listEl.children].forEach(node => mapping[node.dataset.id] = node);
 listEl.innerHTML='';
 for (const id of target){
 listEl.appendChild(mapping[id]);
 }
 feedbackEl.innerHTML = `<span class="warn"><strong>Shown.</strong></span> The recommended order is displayed.`;
 copyBtn.style.display = 'none';
 state.score = null;
 scoreVal.textContent = '–';
 postHeight();
 }

 function resetList(){
 renderList();
 feedbackEl.innerHTML = 'List reset. Arrange the steps, then select <em>Check order</em>.';
 scoreVal.textContent = '–';
 state.score = null;
 copyBtn.style.display = 'none';
 postHeight();
 }

 function attachDnD(){
 let dragEl = null;
 let placeholder = null;

 function createGhost(){
 const g = document.createElement('div');
 g.className = 'ghost';
 return g;
 }
 listEl.addEventListener('dragstart', (e)=>{
 const li = e.target.closest('.item');
 if (!li) return;
 dragEl = li;
 li.classList.add('dragging');
 e.dataTransfer.effectAllowed = 'move';
 placeholder = createGhost();
 // Insert placeholder after dragEl initially
 li.parentNode.insertBefore(placeholder, li.nextSibling);
 });
 listEl.addEventListener('dragend', (e)=>{
 const li = e.target.closest('.item');
 if (!li) return;
 li.classList.remove('dragging');
 placeholder && placeholder.remove();
 placeholder = null;
 dragEl = null;
 // Update order based on DOM
 state.order = [...listEl.children].map(n=>n.dataset.id);
 });
 listEl.addEventListener('dragover', (e)=>{
 e.preventDefault();
 if (!dragEl) return;
 const afterEl = getDragAfterElement(listEl, e.clientY);
 if (afterEl == null){
 listEl.appendChild(placeholder);
 } else {
 listEl.insertBefore(placeholder, afterEl);
 }
 });
 listEl.addEventListener('drop', (e)=>{
 e.preventDefault();
 if (!dragEl || !placeholder) return;
 listEl.insertBefore(dragEl, placeholder);
 placeholder.remove();
 placeholder = null;
 // Update order
 state.order = [...listEl.children].map(n=>n.dataset.id);
 live.textContent = `${getLabel(dragEl.dataset.id)} moved.`;
 });

 function getDragAfterElement(container, y){
 const els = [...container.querySelectorAll('.item:not(.dragging), .ghost')];
 let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
 for (const child of els){
 const box = child.getBoundingClientRect();
 const offset = y - box.top - box.height/2;
 if (offset < 0 && offset > closest.offset){
 closest = {offset, element: child};
 }
 }
 return closest.element;
 }

 // Keyboard move buttons
 listEl.querySelectorAll('.item').forEach(li => {
 li.querySelector('.up').addEventListener('click', ()=> move(li.dataset.id, -1));
 li.querySelector('.down').addEventListener('click', ()=> move(li.dataset.id, +1));
 });
 }

 function escapeHTML(s){
 return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
 }

 function copySummary(){
 const mode = state.mode;
 const target = DATA[mode].map(x=>x.label).join(' → ');
 const current = state.order.map(getLabel).join(' → ');
 const txt = [
 `PPE ${mode[0].toUpperCase()+mode.slice(1)} Order`,
 `Your sequence: ${current}`,
 `Recommended: ${target}`,
 `Score: ${state.score}`
 ].join('\n');
 navigator.clipboard.writeText(txt).then(()=>{
 feedbackEl.innerHTML = `<span class="good"><strong>Copied.</strong></span> A plain-text summary is on the clipboard.`;
 }).catch(()=>{
 feedbackEl.innerHTML = `<span class="warn"><strong>Copy not available.</strong></span> Select and copy the text below.\n<pre>${escapeHTML(txt)}</pre>`;
 });
 }

 // Minimal SCORM hooks
 function setCompletion(score){
 try{
 const api = window.API_1484_11 || window.API;
 if (!api) return;
 if (window.API_1484_11){
 // SCORM 2004
 api.Initialize && api.Initialize('');
 api.SetValue && api.SetValue('cmi.score.raw', String(score));
 api.SetValue && api.SetValue('cmi.completion_status','completed');
 api.SetValue && api.SetValue('cmi.success_status', score>=80 ? 'passed' : 'failed');
 api.Commit && api.Commit('');
 api.Terminate && api.Terminate('');
 } else if (window.API){
 // SCORM 1.2
 api.LMSInitialize && api.LMSInitialize('');
 api.LMSSetValue && api.LMSSetValue('cmi.core.score.raw', String(score));
 api.LMSSetValue && api.LMSSetValue('cmi.core.lesson_status', score>=80 ? 'passed' : 'completed');
 api.LMSCommit && api.LMSCommit('');
 api.LMSFinish && api.LMSFinish('');
 }
 } catch(e){
 console.warn('SCORM setCompletion error', e);
 }
 }

 // Auto-resize for iframes
 function postHeight(){
 if (window.parent !== window){
 const h = document.body.scrollHeight;
 window.parent.postMessage({type:'resize', height:h}, '*');
 }
 }
 window.addEventListener('load', ()=>{ setMode('donning'); postHeight(); });
 window.addEventListener('resize', postHeight);

 // Wire controls
 btnDon.addEventListener('click', ()=> setMode('donning'));
 btnDof.addEventListener('click', ()=> setMode('doffing'));
 checkBtn.addEventListener('click', checkOrder);
 resetBtn.addEventListener('click', resetList);
 copyBtn.addEventListener('click', copySummary);
})();
</script>
</body>
</html>
