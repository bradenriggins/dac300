<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sterilization Flow Auditor - DAC 300 Prototype</title>
<style>
 :root{
 --blue-primary:#01549e; /* DAC 111 primary */
 --blue-secondary:#507ABB; /* DAC 111 secondary */
 --orange-1:#be5510; --orange-2:#cb6015; --teal:#0093b2; --highlight:#fbeeb8;
 --bg:#f7f9fc; --text:#1b2838; --muted:#6b7a90; --card:#ffffff; --ring:#e1e8f5;
 --success:#146c2e; --warn:#a86800; --error:#9b1c1c;
 }
 *{box-sizing:border-box}
 html,body{height:100%}
 body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:var(--bg);color:var(--text);line-height:1.45}
 .wrap{max-width:980px;margin:0 auto;padding:20px 16px 40px}
 h2{margin:0 0 6px 0;font-size:1.6rem;color:var(--blue-primary);letter-spacing:.2px}
 .sub{color:var(--muted);margin:0 0 12px 0;font-size:.98rem}
 hr.divider{border-width:2px;border-color:var(--blue-secondary);padding-left:72px;margin:14px 0 18px}
 .note{background:var(--highlight);padding:10px 12px;border-radius:10px;border:1px solid #eadca2;margin:0 0 12px 0;font-size:.95rem}
 .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
 .panel{display:grid;grid-template-columns:1fr 340px;gap:16px}
 @media (max-width:900px){.panel{grid-template-columns:1fr}}
 .section-title{color:var(--blue-primary);margin:6px 0 8px 0;font-size:1.1rem}
 /* reorder list */
 .board{padding:12px}
 .list{display:flex;flex-direction:column;gap:10px;list-style:none;margin:0;padding:0}
 .item{display:grid;grid-template-columns:1fr auto;align-items:center;gap:8px;background:var(--card);border:1px solid var(--ring);border-radius:12px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.03)}
 .item[draggable="true"]{cursor:grab}
 .item.dragging{opacity:.6}
 .handle{display:flex;flex-direction:column;gap:4px}
 .handle button{appearance:none;border:1px solid var(--ring);background:#f4f7fc;color:#2b3b55;padding:6px 8px;border-radius:8px;cursor:pointer}
 .handle button:focus{outline:2px solid var(--blue-secondary);outline-offset:2px}
 .ghost{height:6px;border:2px dashed var(--teal);border-radius:3px;margin:3px 0;background:rgba(0,147,178,0.2)}
 .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
 .btn{appearance:none;border:1px solid var(--ring);background:var(--blue-primary);color:#fff;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
 .btn.secondary{background:#f4f7fc;color:#123}
 .btn.ghost{background:#fff}
 .btn:disabled{opacity:.6;cursor:not-allowed}
 /* right column */
 .sidebar{padding:12px;display:flex;flex-direction:column;gap:12px}
 .infocard{padding:12px;background:#fff;border:1px solid var(--ring);border-radius:12px}
 .infocard h4{margin:0 0 6px 0;font-size:1.02rem;color:#0f2340}
 .score{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--blue-primary);font-size:1.05rem}
 .rationale{background:#fff7e6;border:1px solid #f0d39a;border-radius:10px;padding:10px;font-size:.96rem}
 .good{color:var(--success)} .warn{color:var(--warn)} .bad{color:var(--error)}
 .sr-only{position:absolute !important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap;border:0;padding:0;margin:-1px}
 /* breach block */
 .breach{margin-top:14px}
 .breach .q{font-weight:700;margin-bottom:6px}
 .options{display:grid;gap:8px}
 .opt{display:flex;gap:8px;align-items:flex-start;border:1px solid var(--ring);background:#fafcff;padding:8px 10px;border-radius:10px}
 .opt input{margin-top:3px}
</style>
</head>
<body>
 <div class="wrap">
 <h2>Sterilization Flow Auditor</h2>
 <hr class="divider">
 <div class="note" role="note">
 <strong>Instructions:</strong> Arrange the instrument processing steps in the correct order, then identify the best fix for the breach scenario. Click <em>Check answers</em> to see how you did. You can also use the Move up and Move down buttons for keyboard control.
 </div>

 <div class="panel">
 <section class="card board" aria-labelledby="ordTitle">
 <h3 id="ordTitle" class="section-title">Order the steps</h3>
 <ul id="list" class="list" aria-live="polite"></ul>
 <div class="actions">
 <button class="btn" id="checkBtn">Check answers</button>
 <button class="btn secondary" id="resetBtn">Reset</button>
 <button class="btn" id="copyBtn" style="display:none;">Copy summary</button>
 </div>

 <div class="breach">
 <h3 class="section-title" style="margin-top:16px">Spot the breach</h3>
 <div id="breachText" class="q"></div>
 <div id="breachOptions" class="options" role="radiogroup" aria-label="Select the best fix"></div>
 </div>

 </section>

 <aside class="sidebar">
 <div class="infocard">
 <h4>Score</h4>
 <div class="score"><span id="scoreVal">–</span></div>
 </div>
 <div class="infocard">
 <h4>Feedback</h4>
 <div id="feedback" class="rationale">Place the steps in order. Then select the best fix for the breach. When you check your answers, the first incorrect step will include a short explanation.</div>
 </div>
 </aside>
 </div>

 <div id="live" class="sr-only" aria-live="polite"></div>
 </div>

<script>
(function(){
 const STEPS = [
 {id:'transport', label:'Transport', rationale:'Move contaminated instruments safely to the processing area. Keep dirty and clean areas separate.'},
 {id:'cleaning', label:'Cleaning', rationale:'Remove debris by ultrasonic cleaner or washer-disinfector; rinse and dry before packaging.'},
 {id:'packaging', label:'Packaging', rationale:'Package instruments in pouches/wraps with indicators. Seal and label before sterilization.'},
 {id:'sterilization', label:'Sterilization', rationale:'Process with appropriate cycle and load spacing. Verify indicators after the cycle.'},
 {id:'storage', label:'Storage', rationale:'Store sterile packs in a clean, dry area. Rotate stock and check integrity before use.'}
 ];

 const BREACHES = [
 {
 id:'unsealed',
 text:'A handpiece is placed in a pouch, but the seam is left partially unsealed before going into the sterilizer.',
 options:[
 {id:'fix1', text:'Seal the pouch completely and reprocess the instrument.', correct:true, why:'Unsealed pouches compromise sterility. Reseal and run a complete cycle again.'},
 {id:'fix2', text:'Add an extra chemical indicator strip inside the pouch and proceed.', correct:false, why:'Indicators do not replace proper packaging. Sterility cannot be assured.'},
 {id:'fix3', text:'Proceed with sterilization, then tape the opening afterward.', correct:false, why:'Post-cycle taping does not create sterile integrity.'}
 ]
 },
 {
 id:'noCleaning',
 text:'Visible debris remains on instruments that were packaged and put into the sterilizer.',
 options:[
 {id:'fix1', text:'Return to the cleaning step to remove debris and dry instruments, then repackage.', correct:true, why:'Debris shields microbes from the sterilant. Clean and dry before packaging.'},
 {id:'fix2', text:'Increase the sterilization temperature for this load only.', correct:false, why:'Changing cycle parameters is not an approved correction for improper cleaning.'},
 {id:'fix3', text:'Place two pouches around each instrument to improve protection.', correct:false, why:'Double-bagging does not compensate for inadequate cleaning.'}
 ]
 },
 {
 id:'tightLoad',
 text:'The sterilizer chamber is tightly packed with no space between pouches.',
 options:[
 {id:'fix1', text:'Redistribute the load to allow space for steam or heat circulation.', correct:true, why:'Air/steam circulation around packs is required for effective sterilization.'},
 {id:'fix2', text:'Add a chemical indicator to the middle of the load and continue.', correct:false, why:'Indicators measure exposure; they do not correct poor load configuration.'},
 {id:'fix3', text:'Extend the dry time by 10 minutes and continue.', correct:false, why:'Dry time adjustments do not fix inadequate exposure caused by tight loading.'}
 ]
 },
 {
 id:'noIndicator',
 text:'Pouches are sealed and labeled, but there is no internal chemical indicator inside the packs.',
 options:[
 {id:'fix1', text:'Place an internal chemical indicator in each pack and reprocess.', correct:true, why:'Each pack needs an internal chemical indicator to verify parameter reach.'},
 {id:'fix2', text:'Rely on the external indicator only for this batch.', correct:false, why:'External indicators do not confirm internal pack conditions.'},
 {id:'fix3', text:'Open one pack after the cycle to check it and assume the rest are fine.', correct:false, why:'Spot checks cannot verify every pack; correct the setup and reprocess.'}
 ]
 }
 ];

 const state = { order:[], score:null, breach:null, choice:null };

 const listEl = document.getElementById('list');
 const feedbackEl = document.getElementById('feedback');
 const scoreVal = document.getElementById('scoreVal');
 const copyBtn = document.getElementById('copyBtn');
 const resetBtn = document.getElementById('resetBtn');
 const checkBtn = document.getElementById('checkBtn');
 const live = document.getElementById('live');
 const breachText = document.getElementById('breachText');
 const breachOptions = document.getElementById('breachOptions');

 function init(){
 renderList(STEPS);
 pickBreach();
 scoreVal.textContent = '–';
 feedbackEl.innerHTML = 'Place the steps in order. Then select the best fix for the breach. When you check your answers, the first incorrect step will include a short explanation.';
 copyBtn.style.display = 'none';
 }

 function renderList(items){
 listEl.innerHTML = '';
 state.order = items.map(x=>x.id);
 for (const item of items){
 const li = document.createElement('li');
 li.className = 'item';
 li.setAttribute('draggable','true');
 li.dataset.id = item.id;
 li.innerHTML = `
 <div>
 <div style="font-weight:700">${escapeHTML(item.label)}</div>
 <div style="font-size:.9rem;color:#38506e">Step</div>
 </div>
 <div class="handle" aria-label="Reorder controls">
 <button type="button" class="up" aria-label="Move up">Move up</button>
 <button type="button" class="down" aria-label="Move down">Move down</button>
 </div>
 `;
 listEl.appendChild(li);
 }
 attachDnD();
 }

 function pickBreach(){
 const idx = Math.floor(Math.random()*BREACHES.length);
 state.breach = BREACHES[idx];
 breachText.textContent = state.breach.text;
 renderOptions(state.breach.options);
 }

 function renderOptions(options){
 breachOptions.innerHTML = '';
 options.forEach((opt,i)=>{
 const id = `opt_${opt.id}`;
 const wrap = document.createElement('label');
 wrap.className = 'opt';
 wrap.innerHTML = `
 <input type="radio" name="breachFix" id="${id}" value="${opt.id}">
 <div>${escapeHTML(opt.text)}</div>
 `;
 breachOptions.appendChild(wrap);
 });
 state.choice = null;
 breachOptions.addEventListener('change', (e)=>{
 if (e.target && e.target.name === 'breachFix'){
 state.choice = e.target.value;
 }
 }, { once:true });
 }

 function indexById(id){ return state.order.indexOf(id); }

 function move(id, dir){
 const i = indexById(id); const j = i + dir;
 if (i<0 || j<0 || j>=state.order.length) return;
 const arr = state.order; [arr[i], arr[j]] = [arr[j], arr[i]];
 const nodes = [...listEl.children];
 const nodeI = nodes[i]; const nodeJ = nodes[j];
 if (dir === 1){ listEl.insertBefore(nodeJ, nodeI); } else { listEl.insertBefore(nodeI, nodeJ); }
 live.textContent = `${getLabel(arr[i])} moved ${dir===1?'down':'up'}.`;
 }

 function getLabel(id){ const found = STEPS.find(x=>x.id===id); return found?found.label:id; }
 function getRationale(id){ const found = STEPS.find(x=>x.id===id); return found?found.rationale:''; }

 function checkAll(){
 const orderResult = checkOrder();
 const breachResult = checkBreach();
 const total = Math.round(orderResult.score*0.8) + (breachResult.correct?20:0);
 state.score = total;
 scoreVal.textContent = String(total);
 // Show copy button only on fully correct
 copyBtn.style.display = (orderResult.score===100 && breachResult.correct) ? 'inline-block' : 'none';
 }

 function checkOrder(){
 const target = STEPS.map(x=>x.id);
 const current = state.order.slice();
 let firstWrongIdx = -1;
 for (let i=0;i<target.length;i++){ if (current[i] !== target[i]){ firstWrongIdx = i; break; } }
 let score = 0;
 if (firstWrongIdx === -1){
 score = 100;
 feedbackEl.innerHTML = `<span class="good"><strong>Order correct.</strong></span> Your sequence matches the recommended flow.`;
 } else {
 const mismatches = [];
 for (let i=0;i<target.length;i++){ if (current[i] !== target[i]) mismatches.push(i); }
 const singleSwap = (mismatches.length === 2) && (current[mismatches[0]] === target[mismatches[1]]) && (current[mismatches[1]] === target[mismatches[0]]);
 score = singleSwap ? 80 : 50;
 const wrongId = current[firstWrongIdx];
 const correctId = target[firstWrongIdx];
 const rationale = getRationale(correctId);
 feedbackEl.innerHTML = `<div class="rationale"><strong>Check step ${firstWrongIdx+1}.</strong> You placed <em>${escapeHTML(getLabel(wrongId))}</em>, but the recommended step is <em>${escapeHTML(getLabel(correctId))}</em>. ${escapeHTML(rationale)}</div>`;
 }
 return {score, firstWrongIdx};
 }

 function checkBreach(){
 const b = state.breach; if (!b) return {correct:false, msg:'No scenario loaded.'};
 const choice = state.choice;
 const selected = b.options.find(o=>o.id===choice);
 if (!selected){
 // Nudge but keep gentle
 if (!feedbackEl.innerHTML.includes('Select a fix')){
 feedbackEl.innerHTML += `<div class=\"rationale\" style=\"margin-top:8px\"><strong>Select a fix for the breach.</strong> Then check answers again.</div>`;
 }
 return {correct:false, msg:'No fix selected.'};
 }
 if (selected.correct){
 // Append positive note without overwriting order feedback
 feedbackEl.innerHTML += `<div class="good" style="margin-top:6px"><strong>Breach fix correct.</strong> ${escapeHTML(selected.why)}</div>`;
 return {correct:true, msg:selected.why};
 } else {
 feedbackEl.innerHTML += `<div class="bad" style="margin-top:6px"><strong>Fix not correct.</strong> ${escapeHTML(selected.why)}</div>`;
 return {correct:false, msg:selected.why};
 }
 }

 function showCorrect(){
 const target = STEPS.map(x=>x.id);
 state.order = target.slice();
 const map = {}; [...listEl.children].forEach(n=> map[n.dataset.id]=n);
 listEl.innerHTML='';
 for (const id of target){ listEl.appendChild(map[id]); }
 feedbackEl.innerHTML = `<span class="warn"><strong>Shown.</strong></span> The recommended order is displayed.`;
 copyBtn.style.display = 'none';
 state.score = null; scoreVal.textContent = '–';
 }

 function resetAll(){
 renderList(STEPS);
 pickBreach();
 feedbackEl.innerHTML = 'Reset complete. Place the steps in order and select the best fix for the breach.';
 scoreVal.textContent = '–';
 state.score = null; state.choice = null;
 copyBtn.style.display = 'none';
 }

 function attachDnD(){
 let dragEl = null; let placeholder = null;
 function createGhost(){ const g=document.createElement('div'); g.className='ghost'; return g; }

 listEl.addEventListener('dragstart', (e)=>{
 const li = e.target.closest('.item'); if (!li) return;
 dragEl = li; li.classList.add('dragging'); e.dataTransfer.effectAllowed='move';
 placeholder = createGhost(); li.parentNode.insertBefore(placeholder, li.nextSibling);
 });
 listEl.addEventListener('dragend', (e)=>{
 const li = e.target.closest('.item'); if (!li) return;
 li.classList.remove('dragging'); if (placeholder){ placeholder.remove(); placeholder=null; }
 dragEl = null; state.order = [...listEl.children].map(n=>n.dataset.id);
 });
 listEl.addEventListener('dragover', (e)=>{
 e.preventDefault(); if (!dragEl) return;
 const afterEl = getDragAfterElement(listEl, e.clientY);
 if (afterEl==null){ listEl.appendChild(placeholder); } else { listEl.insertBefore(placeholder, afterEl); }
 });
 listEl.addEventListener('drop', (e)=>{
 e.preventDefault(); if (!dragEl || !placeholder) return;
 listEl.insertBefore(dragEl, placeholder); placeholder.remove(); placeholder=null;
 state.order = [...listEl.children].map(n=>n.dataset.id); live.textContent = `${getLabel(dragEl.dataset.id)} moved.`;
 });

 function getDragAfterElement(container, y){
 const els = [...container.querySelectorAll('.item:not(.dragging), .ghost')];
 let closest={offset:Number.NEGATIVE_INFINITY, element:null};
 for (const child of els){
 const box = child.getBoundingClientRect(); const offset = y - box.top - box.height/2;
 if (offset<0 && offset>closest.offset){ closest={offset, element:child}; }
 }
 return closest.element;
 }

 listEl.querySelectorAll('.item').forEach(li=>{
 li.querySelector('.up').addEventListener('click', ()=> move(li.dataset.id,-1));
 li.querySelector('.down').addEventListener('click', ()=> move(li.dataset.id, +1));
 });
 }

 function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

 function copySummary(){
 const orderStr = state.order.map(getLabel).join(' → ');
 const targetStr = STEPS.map(x=>x.label).join(' → ');
 const breach = state.breach ? state.breach.text : '';
 const chosen = state.choice || '(none)';
 const score = state.score==null ? '–' : String(state.score);
 const txt = [
 'Sterilization Flow Auditor',
 `Your order: ${orderStr}`,
 `Recommended: ${targetStr}`,
 `Breach: ${breach}`,
 `Selected fix: ${chosen}`,
 `Score: ${score}`
 ].join('\n');
 navigator.clipboard.writeText(txt).then(()=>{
 feedbackEl.innerHTML += `<div class="good" style="margin-top:6px"><strong>Copied.</strong> Summary placed on clipboard.</div>`;
 }).catch(()=>{
 feedbackEl.innerHTML += `<div class="warn" style="margin-top:6px"><strong>Copy not available.</strong> Select the text below.\n<pre>${escapeHTML(txt)}</pre></div>`;
 });
 }

 // Wire controls
 window.addEventListener('load', init);
 checkBtn.addEventListener('click', checkAll);
 resetBtn.addEventListener('click', resetAll);
 copyBtn.addEventListener('click', copySummary);
})();
</script>
</body>
</html>
